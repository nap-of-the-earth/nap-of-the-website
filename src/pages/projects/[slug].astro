---
import BaseLayout from "@layouts/BaseLayout.astro";
import Section from "@components/astro/Section.astro";
import { getCollection, render } from "astro:content";
import { formatDate } from "@lib/utils";

export const prerender = true;

export async function getStaticPaths() {
  const projects = await getCollection("projects");
  return projects.map((project) => ({
    params: { slug: project.id.replace(/\.mdx?$/, "") },
    props: { project },
  }));
}

const { project } = Astro.props;
const { Content } = await render(project);

// Related projects: share ≥1 tag, exclude self, max 3
const allProjects = await getCollection("projects");
const currentTags = new Set(project.data.tags);
const related = allProjects
  .filter((p) => p.id !== project.id && p.data.tags.some((t: string) => currentTags.has(t)))
  .sort((a, b) => {
    const aOverlap = a.data.tags.filter((t: string) => currentTags.has(t)).length;
    const bOverlap = b.data.tags.filter((t: string) => currentTags.has(t)).length;
    return bOverlap - aOverlap;
  })
  .slice(0, 3);
---

<BaseLayout title={project.data.title} description={project.data.description}>
  <Section class="pt-32 pb-24">
    <div class="max-w-[800px] mx-auto">
      {/* Back link */}
      <a
        href="/projects"
        class="inline-flex items-center gap-2 text-sm text-text-secondary hover:text-teal transition-colors no-underline mb-12"
      >
        <span>←</span> Back to Projects
      </a>

      {/* Header */}
      <div class="mb-12">
        <div class="flex items-center gap-3 mb-4">
          <span class="font-mono text-[0.65rem] text-teal tracking-[0.1em] uppercase">
            {project.data.category}
          </span>
          <span class="text-text-tertiary">·</span>
          <span class="font-mono text-[0.65rem] text-text-tertiary">
            {formatDate(project.data.date)}
          </span>
        </div>

        <h1 class="text-4xl font-bold tracking-tight mb-4">
          {project.data.title}
        </h1>

        <p class="text-lg font-normal leading-relaxed text-text-secondary">
          {project.data.description}
        </p>

        {/* Tags */}
        <div class="flex gap-2 mt-6 flex-wrap">
          {project.data.tags.map((tag: string) => (
            <span class="font-mono text-[0.65rem] text-text-tertiary bg-bg-card border border-border px-3 py-1 rounded-md">
              {tag}
            </span>
          ))}
        </div>

        {/* Links */}
        <div class="flex gap-4 mt-6">
          {project.data.liveUrl && (
            <a
              href={project.data.liveUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="btn-glow text-sm"
            >
              Live Demo ↗
            </a>
          )}
          {project.data.repoUrl && (
            <a
              href={project.data.repoUrl}
              target="_blank"
              rel="noopener noreferrer"
              class="btn-outline text-sm"
            >
              Source Code ↗
            </a>
          )}
        </div>
      </div>

      {/* Divider */}
      <hr class="border-border mb-12" />

      {/* MDX Content */}
      <div class="prose">
        <Content />
      </div>
    </div>
  </Section>

  {/* Related Projects */}
  {related.length > 0 && (
    <Section class="py-16 border-t border-border">
      <div class="max-w-[800px] mx-auto">
        <p class="font-mono text-[0.7rem] tracking-[0.15em] uppercase text-text-tertiary mb-8">
          Related Projects
        </p>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
          {related.map((r) => (
            <a
              href={`/projects/${r.id.replace(/\.mdx?$/, "")}`}
              class="omnius-card block no-underline group"
            >
              <p class="font-mono text-[0.6rem] text-teal tracking-[0.1em] uppercase mb-1">
                {r.data.category}
              </p>
              <h3 class="text-sm font-semibold text-text-primary mb-1 group-hover:text-teal transition-colors">
                {r.data.title}
              </h3>
              <p class="text-xs font-normal text-text-secondary line-clamp-2">
                {r.data.description}
              </p>
            </a>
          ))}
        </div>
      </div>
    </Section>
  )}
</BaseLayout>
